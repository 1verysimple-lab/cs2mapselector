<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS2 Strategy Roulette</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Impact&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #050505;
            color: #e0e0e0;
            overflow: hidden;
            user-select: none;
            perspective: 1500px;
        }
        
        .font-impact { font-family: 'Impact', sans-serif; letter-spacing: 1px; }

        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #333; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background-color: #2cc985; }

        .btn-action {
            background-color: #2cc985;
            color: #000;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .btn-action:hover:not(:disabled) {
            background-color: #25a870;
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(44, 201, 133, 0.4);
        }
        .btn-action:disabled {
            background-color: #1a1a1a;
            color: #444;
            border: 1px solid #333;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        input[type="checkbox"] {
            accent-color: #2cc985;
            width: 14px;
            height: 14px;
            cursor: pointer;
            filter: grayscale(0.2);
            transition: filter 0.2s;
        }
        input[type="checkbox"]:hover { filter: grayscale(0); }

        /* --- 3D STAGE STYLING --- */
        #gameBoard {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            transform-style: preserve-3d;
        }
        
        #aspectRatioBox {
            position: relative;
            aspect-ratio: 16 / 9; 
            max-width: 100%;
            max-height: 100%;
            transform-style: preserve-3d; 
            transition: transform 0.1s ease-out;
            box-shadow: 0 30px 60px rgba(0,0,0,0.8), 0 0 0 1px #333;
        }

        #cardImage {
            width: 100%;
            height: 100%;
            display: block;
            border-radius: 4px;
            transform: translateZ(0px); 
        }

        #crosshair {
            position: absolute;
            pointer-events: none;
            z-index: 20;
            transition: all 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            opacity: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            border: 3px solid #2cc985;
            box-shadow: 0 0 10px rgba(44, 201, 133, 0.5), inset 0 0 20px rgba(44, 201, 133, 0.2), 0 0 0 9999px rgba(0, 0, 0, 0.75);
            border-radius: 4px;
            transform: translateZ(30px); 
        }
        #crosshair::after {
            content: '';
            width: 4px;
            height: 4px;
            background-color: #2cc985;
            border-radius: 50%;
            box-shadow: 0 0 4px #2cc985;
        }

        #winnerTextContainer { transform: translateZ(60px); }

        @keyframes popIn {
            0% { transform: scale(0.8) translateZ(60px); opacity: 0; }
            100% { transform: scale(1) translateZ(60px); opacity: 1; }
        }
        .animate-winner { animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }

        .glass-panel {
            background: rgba(15, 15, 15, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid #222;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body class="h-screen flex flex-col bg-[#050505]">

    <!-- Audio Element -->
    <audio id="bgMusic" loop></audio>

    <!-- HEADER -->
    <header class="bg-[#0f0f0f]/90 backdrop-blur border-b border-[#222] h-16 flex items-center justify-between px-6 shrink-0 z-30">
        <div class="flex items-center gap-4">
            <div class="h-8 w-1 bg-[#2cc985] rounded-full shadow-[0_0_10px_#2cc985]"></div>
            
            <!-- Sound Toggle Button -->
            <button id="btnSound" class="text-gray-400 hover:text-[#2cc985] transition-colors p-1" title="Toggle Music">
                <!-- Icon injected by JS -->
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>
            </button>

            <div class="h-6 w-px bg-[#333] mx-2"></div>

            <select id="modeSelect" class="bg-[#1a1a1a] text-sm text-gray-200 border border-[#333] rounded px-3 py-1.5 outline-none focus:border-[#2cc985] hover:border-[#444] transition-colors cursor-pointer min-w-[140px]">
                <option value="Premier">Premier</option>
                <option value="Competitive">Competitive</option>
                <option value="Wingman">Wingman</option>
            </select>
        </div>
        <button id="btnRandomMode" class="text-xs font-bold text-gray-400 hover:text-white px-3 py-1.5 rounded border border-[#333] hover:border-[#555] transition-all uppercase tracking-wider">
            Random Mode
        </button>
    </header>

    <!-- MAIN STAGE -->
    <main class="flex-grow relative w-full h-full overflow-hidden flex flex-col perspective-container">
        <div id="gameBoard">
            <div id="aspectRatioBox">
                <img id="cardImage" src="" alt="Game Mode" class="select-none">
                <div id="crosshair"></div>
                <div id="defaultText" class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none hidden" style="transform: translateZ(20px);">
                    <h1 class="font-impact text-7xl text-[#222] select-none opacity-50 tracking-tighter">CS2</h1>
                </div>
                <div id="winnerTextContainer" class="absolute inset-0 flex items-center justify-center z-40 pointer-events-none hidden">
                    <div class="bg-black/80 backdrop-blur-sm px-8 py-4 rounded-xl border border-[#2cc985] shadow-[0_0_30px_rgba(44,201,133,0.2)] animate-winner">
                        <h1 id="winnerText" class="font-impact text-6xl text-[#2cc985] tracking-wide uppercase text-center">
                            MIRAGE
                        </h1>
                    </div>
                </div>
            </div>
        </div>

        <!-- HISTORY PANEL -->
        <div id="historyContainer" class="absolute top-4 left-4 z-40 w-56 glass-panel rounded-lg transition-all duration-300 flex flex-col">
            <div class="flex items-center justify-between p-3 border-b border-[#222] cursor-pointer hover:bg-[#1a1a1a] rounded-t-lg group" onclick="toggleHistoryMinimize()">
                <div class="flex items-center gap-2">
                    <span class="text-[#2cc985] text-xs">↺</span>
                    <span class="text-xs font-bold text-gray-300 uppercase tracking-widest group-hover:text-white">History</span>
                </div>
                <svg id="historyChevron" class="w-4 h-4 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </div>
            <div id="historyListWrapper" class="overflow-hidden transition-[max-height] duration-300 ease-in-out max-h-[60vh]">
                <div id="historyList" class="custom-scroll overflow-y-auto p-2 space-y-1 max-h-[40vh] min-h-[50px]">
                    <p class="text-[10px] text-gray-600 text-center italic py-2">No maps picked yet.</p>
                </div>
                <div class="p-2 border-t border-[#222] bg-[#0a0a0a]">
                    <button onclick="clearHistory()" class="w-full text-[10px] text-gray-500 hover:text-red-400 uppercase font-bold py-1 transition-colors">Clear History</button>
                </div>
            </div>
        </div>

        <!-- VETO PANEL -->
        <div id="vetoContainer" class="absolute top-4 right-4 z-40 w-64 glass-panel rounded-lg transition-all duration-300 flex flex-col">
            <div class="flex items-center justify-between p-3 border-b border-[#222] cursor-pointer hover:bg-[#1a1a1a] rounded-t-lg group" onclick="toggleVetoMinimize()">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-[#2cc985]"></div>
                    <span class="text-xs font-bold text-gray-300 uppercase tracking-widest group-hover:text-white">Map Pool</span>
                </div>
                <svg id="vetoChevron" class="w-4 h-4 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </div>
            <div id="vetoListWrapper" class="overflow-hidden transition-[max-height] duration-300 ease-in-out max-h-[85vh]">
                <div id="vetoList" class="custom-scroll overflow-y-auto p-2 space-y-0.5 max-h-[75vh]"></div>
                <div class="p-2 border-t border-[#222] bg-[#0a0a0a]">
                    <button onclick="resetVetoes()" class="w-full text-[10px] text-gray-500 hover:text-gray-300 uppercase font-bold py-1">Reset All</button>
                </div>
            </div>
        </div>

        <!-- PREMIER NOTICE -->
        <div id="premierMessage" class="absolute top-4 right-4 z-40 glass-panel rounded px-4 py-3 hidden">
            <div class="flex items-center gap-3">
                <span class="text-[#2cc985] text-xl">♔</span>
                <span class="text-gray-400 text-sm font-medium">Pick/Ban Phase Active</span>
            </div>
        </div>
    </main>

    <!-- FOOTER -->
    <footer class="bg-[#0f0f0f] border-t border-[#222] p-4 shrink-0 z-30">
        <div class="max-w-2xl mx-auto">
            <button id="btnAction" class="btn-action w-full font-impact text-3xl py-3 rounded tracking-widest uppercase text-black shadow-lg flex items-center justify-center gap-3">
                <span>PICK MAP</span>
            </button>
        </div>
    </footer>

    <script>
        // --- DATA & CONFIG ---
        const gridConfigs = {
            "Competitive": { cols: 7, rows: 2, startX: 0.8, startY: 12, gapX: 14.2, gapY: 42, width: 13.5, height: 38 },
            "Wingman": { cols: 5, rows: 1, startX: 1, startY: 12, gapX: 20, gapY: 0, width: 19.5, height: 75 }
        };

        const mapPool = {
            "Premier": [], 
            "Competitive": ["Dust II", "Mirage", "Inferno", "Ancient", "Nuke", "Train", "Overpass", "Anubis", "Vertigo", "Palacio", "Golden", "Agency", "Office", "Italy"],
            "Wingman": ["Rooftop", "Overpass", "Vertigo", "Nuke", "Inferno"]
        };

        const modeImages = {
            "Premier": "assets/premier.png",
            "Competitive": "assets/competitive.jpg",
            "Wingman": "assets/wingman.jpg"
        };
        
        // Audio Assets
        const musicTracks = ["assets/bluemap0.mp3", "assets/bluemap1.mp3"];

        // --- STATE ---
        let state = {
            currentMode: "Premier",
            vetoes: {}, 
            history: { "Competitive": [], "Wingman": [] }
        };
        let isShuffling = false;
        let isVetoMinimized = false;
        let isHistoryMinimized = false;
        let isMuted = false;

        // --- ELEMENTS ---
        const els = {
            modeSelect: document.getElementById('modeSelect'),
            btnRandomMode: document.getElementById('btnRandomMode'),
            btnSound: document.getElementById('btnSound'),
            bgMusic: document.getElementById('bgMusic'),
            gameBoard: document.getElementById('gameBoard'),
            aspectRatioBox: document.getElementById('aspectRatioBox'),
            cardImage: document.getElementById('cardImage'),
            crosshair: document.getElementById('crosshair'),
            vetoContainer: document.getElementById('vetoContainer'),
            vetoList: document.getElementById('vetoList'),
            vetoChevron: document.getElementById('vetoChevron'),
            vetoListWrapper: document.getElementById('vetoListWrapper'),
            historyContainer: document.getElementById('historyContainer'),
            historyList: document.getElementById('historyList'),
            historyChevron: document.getElementById('historyChevron'),
            historyListWrapper: document.getElementById('historyListWrapper'),
            premierMessage: document.getElementById('premierMessage'),
            btnAction: document.getElementById('btnAction'),
            winnerTextContainer: document.getElementById('winnerTextContainer'),
            winnerText: document.getElementById('winnerText'),
            defaultText: document.getElementById('defaultText')
        };

        // --- INIT ---
        function init() {
            loadSettings();
            initAudio();

            els.modeSelect.value = state.currentMode;
            updateModeLogic(state.currentMode);

            els.modeSelect.addEventListener('change', (e) => updateModeLogic(e.target.value));
            els.btnRandomMode.addEventListener('click', animateRandomMode);
            els.btnAction.addEventListener('click', startMapShuffle);
            els.btnSound.addEventListener('click', toggleAudio);
            
            els.cardImage.onload = function() {
                els.aspectRatioBox.style.aspectRatio = `${this.naturalWidth} / ${this.naturalHeight}`;
            };

            document.addEventListener('mousemove', handleTilt);
            
            // Interaction fallback for audio
            document.addEventListener('click', () => {
                if (els.bgMusic.paused && !isMuted) {
                    els.bgMusic.play().catch(() => {});
                }
            }, { once: true });
        }

        // --- AUDIO LOGIC ---
        function initAudio() {
            // Pick random track
            const track = musicTracks[Math.floor(Math.random() * musicTracks.length)];
            els.bgMusic.src = track;
            els.bgMusic.volume = 0.4; // Initial volume

            // Try to play automatically
            const playPromise = els.bgMusic.play();
            
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    console.log("Autoplay prevented by browser. Waiting for interaction.");
                    isMuted = true; // Visually set to muted initially if blocked
                    updateSoundIcon();
                });
            }
            updateSoundIcon();
        }

        function toggleAudio() {
            if (els.bgMusic.paused) {
                els.bgMusic.play();
                isMuted = false;
            } else {
                els.bgMusic.pause();
                isMuted = true;
            }
            updateSoundIcon();
        }

        function updateSoundIcon() {
            if (isMuted || els.bgMusic.paused) {
                // Muted Icon
                els.btnSound.innerHTML = `<svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"></path></svg>`;
            } else {
                // Speaker Icon
                els.btnSound.innerHTML = `<svg class="w-5 h-5 text-[#2cc985]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>`;
            }
        }

        // --- STORAGE ---
        function loadSettings() {
            const saved = localStorage.getItem('cs2_roulette_data_v1');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    if (parsed.currentMode) state.currentMode = parsed.currentMode;
                    if (parsed.vetoes) state.vetoes = parsed.vetoes;
                    if (parsed.history) state.history = parsed.history;
                } catch (e) { console.error(e); }
            }
        }

        function saveSettings() {
            localStorage.setItem('cs2_roulette_data_v1', JSON.stringify({
                currentMode: state.currentMode,
                vetoes: state.vetoes,
                history: state.history
            }));
        }

        // --- 3D TILT ---
        function handleTilt(e) {
            if (window.innerWidth < 768) return; 
            const x = e.clientX / window.innerWidth;
            const y = e.clientY / window.innerHeight;
            const rotateY = (x - 0.5) * 20; 
            const rotateX = (0.5 - y) * 20; 
            els.aspectRatioBox.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
        }

        // --- GAME LOGIC ---
        function updateModeLogic(mode) {
            state.currentMode = mode;
            saveSettings();
            els.modeSelect.value = mode;
            els.winnerTextContainer.classList.add('hidden');
            els.crosshair.style.opacity = '0';
            els.btnAction.innerHTML = "<span>PICK RANDOM MAP</span>";
            els.cardImage.src = modeImages[mode];

            if (mode === "Premier") {
                els.vetoContainer.classList.add('hidden');
                els.historyContainer.classList.add('hidden'); 
                els.premierMessage.classList.remove('hidden');
                els.btnAction.disabled = true;
                els.btnAction.innerHTML = "<span>PICK/BAN IN GAME</span>";
                els.defaultText.classList.remove('hidden');
            } else {
                els.vetoContainer.classList.remove('hidden');
                els.historyContainer.classList.remove('hidden');
                els.premierMessage.classList.add('hidden');
                els.btnAction.disabled = false;
                els.defaultText.classList.add('hidden');
                renderVetoList(mode);
                renderHistoryList(mode);
            }
        }

        function renderVetoList(mode) {
            els.vetoList.innerHTML = '';
            const maps = mapPool[mode];
            if (!state.vetoes[mode]) state.vetoes[mode] = {};

            maps.forEach(map => {
                const isActive = state.vetoes[mode][map] !== false; 
                const row = document.createElement('label');
                row.className = "flex items-center gap-3 p-1.5 hover:bg-white/5 rounded cursor-pointer group select-none";
                const checkbox = document.createElement('input');
                checkbox.type = "checkbox";
                checkbox.checked = isActive;
                checkbox.onchange = (e) => {
                    state.vetoes[mode][map] = e.target.checked;
                    saveSettings();
                };
                const span = document.createElement('span');
                span.innerText = map;
                span.className = "text-gray-400 text-sm font-medium group-hover:text-gray-200 transition-colors";
                row.appendChild(checkbox);
                row.appendChild(span);
                els.vetoList.appendChild(row);
            });
        }

        function renderHistoryList(mode) {
            els.historyList.innerHTML = '';
            const history = state.history[mode] || [];
            if (history.length === 0) {
                els.historyList.innerHTML = '<p class="text-[10px] text-gray-600 text-center italic py-2">No maps picked yet.</p>';
                return;
            }
            history.slice().reverse().slice(0, 10).forEach((entry, index) => {
                const item = document.createElement('div');
                item.className = "flex justify-between items-center p-2 bg-white/5 rounded border border-white/5 mb-1 animate-winner";
                item.style.animationDelay = `${index * 50}ms`;
                item.innerHTML = `
                    <span class="text-xs font-bold text-gray-300">${entry.map}</span>
                    <span class="text-[10px] text-gray-500">${new Date(entry.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                `;
                els.historyList.appendChild(item);
            });
        }

        function addToHistory(map) {
            const mode = state.currentMode;
            if (!state.history[mode]) state.history[mode] = [];
            state.history[mode].push({ map: map, timestamp: Date.now() });
            saveSettings();
            renderHistoryList(mode);
        }

        function clearHistory() {
            if (!state.history[state.currentMode]) return;
            state.history[state.currentMode] = [];
            saveSettings();
            renderHistoryList(state.currentMode);
        }

        function getMapCoordinates(mapName) {
            const fullList = mapPool[state.currentMode];
            const index = fullList.indexOf(mapName);
            const config = gridConfigs[state.currentMode];
            if (index === -1 || !config) return null;
            const row = Math.floor(index / config.cols);
            const col = index % config.cols;
            const left = config.startX + (col * config.gapX);
            const top = config.startY + (row * config.gapY);
            return { top, left, width: config.width, height: config.height };
        }

        function moveCrosshairTo(mapName) {
            const coords = getMapCoordinates(mapName);
            if (!coords) return;
            els.crosshair.style.opacity = '1';
            els.crosshair.style.top = coords.top + '%';
            els.crosshair.style.left = coords.left + '%';
            els.crosshair.style.width = coords.width + '%';
            els.crosshair.style.height = coords.height + '%';
        }

        function toggleVetoMinimize() {
            isVetoMinimized = !isVetoMinimized;
            els.vetoListWrapper.style.maxHeight = isVetoMinimized ? '0px' : '85vh';
            els.vetoChevron.style.transform = isVetoMinimized ? 'rotate(180deg)' : 'rotate(0deg)';
        }

        function toggleHistoryMinimize() {
            isHistoryMinimized = !isHistoryMinimized;
            els.historyListWrapper.style.maxHeight = isHistoryMinimized ? '0px' : '60vh';
            els.historyChevron.style.transform = isHistoryMinimized ? 'rotate(180deg)' : 'rotate(0deg)';
        }

        function resetVetoes() {
            if(confirm("Enable all maps?")) {
                state.vetoes[state.currentMode] = {}; 
                saveSettings();
                renderVetoList(state.currentMode);
            }
        }

        function animateRandomMode() {
            if (isShuffling) return;
            const modes = Object.keys(mapPool);
            let iterations = 0;
            els.btnRandomMode.disabled = true;
            const timer = setInterval(() => {
                const randomMode = modes[Math.floor(Math.random() * modes.length)];
                els.modeSelect.value = randomMode; 
                if (iterations >= 12) {
                    clearInterval(timer);
                    const finalMode = modes[Math.floor(Math.random() * modes.length)];
                    updateModeLogic(finalMode);
                    els.btnRandomMode.disabled = false;
                }
                iterations++;
            }, 80);
        }

        function startMapShuffle() {
            if (state.currentMode === "Premier" || isShuffling) return;
            const allMaps = mapPool[state.currentMode];
            const activeMaps = allMaps.filter(m => state.vetoes[state.currentMode]?.[m] !== false);
            if (activeMaps.length === 0) return alert("Select at least one map.");

            isShuffling = true;
            els.btnAction.disabled = true;
            els.btnAction.innerHTML = "<span>SEARCHING...</span>";
            els.winnerTextContainer.classList.add('hidden');
            
            let iterations = 0;
            const maxIterations = 25; 
            let speed = 60;

            function shuffleStep() {
                const randomMap = activeMaps[Math.floor(Math.random() * activeMaps.length)];
                moveCrosshairTo(randomMap);
                iterations++;
                if (iterations < maxIterations) {
                    if (iterations > maxIterations - 8) speed *= 1.2;
                    setTimeout(shuffleStep, speed);
                } else {
                    finishShuffle(activeMaps);
                }
            }
            shuffleStep();
        }

        function finishShuffle(activeMaps) {
            const winner = activeMaps[Math.floor(Math.random() * activeMaps.length)];
            moveCrosshairTo(winner);
            setTimeout(() => {
                els.winnerText.innerText = winner.toUpperCase();
                els.winnerTextContainer.classList.remove('hidden');
                addToHistory(winner); 
                isShuffling = false;
                els.btnAction.disabled = false;
                els.btnAction.innerHTML = "<span>PICK RANDOM MAP</span>";
            }, 200);
        }

        init();
    </script>
</body>
</html>